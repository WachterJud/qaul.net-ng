version: 2.1

# ------------------------------------------------
# Configurations
# ------------------------------------------------
flutter_version: &flutter_version
  FLUTTER_VERSION: "2.8.0"
default_flutter_wdir: &default_flutter_wdir
  working_directory: ~/qaul-libp2p/qaul_ui
flutter_ios_dir: &flutter_ios_dir
  working_directory: ~/qaul-libp2p/qaul_ui/ios
checkout_to_root: &checkout_to_root
  steps:
    - checkout:
        path: ~/qaul-libp2p

aliases:
  - &restore_git_cache
    name: Restore GIT cache
    keys:
      - source-v1-{{ .Branch }}-{{ .Revision }}
      - source-v1-{{ .Branch }}-
      - source-v1-
  - &save_git_cache
    name: Save GIT cache
    key: source-v1-{{ .Branch }}-{{ .Revision }}
    paths:
      - .git

executors:
  flutter:
    docker:
      - image: cirrusci/flutter:stable
    <<: *default_flutter_wdir
  android-flutter:
    docker:
      - image: cimg/android:2021.10
    resource_class: large
    <<: *default_flutter_wdir
  android-rust:
    docker:
      - image: cimg/android:2022.03-ndk
    resource_class: large

jobs:
  # ------------------------------------------------
  # Integration Jobs
  # ------------------------------------------------
  flutter-analyze:
    executor: flutter
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - install-flutter-deps
      - run: flutter analyze
  flutter-test:
    executor: flutter
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - install-flutter-deps
      - run: flutter test
  # ------------------------------------------------
  # Deploy Jobs
  # ------------------------------------------------
  # #  ---------------------------------------------
  # #  Rust
  # #  ---------------------------------------------
  build-libqaul-android:
    executor: android-rust
    working_directory: ~/qaul-libp2p
    shell: /bin/bash --login -o pipefail
    environment:
      ANDROID_NDK_HOME: /home/circleci/android-sdk/ndk/22.1.7171670
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - run:
          name: Install Rust
          command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Install build targets for android in rust
          command: rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android
      - run:
          name: Install Cargo NDK
          command: cd rust/libqaul && cargo install cargo-ndk
      - run:
          name: Build Libqaul JniLibs for Android
          command: cd rust/libqaul && sh build_libqaul_android.sh
      - save-sccache-cache
      - restore_cache:
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum  "android/libqaul/build.gradle" }}-{{ checksum  "android/blemodule/build.gradle" }}
      - run:
          name: Build AAR Library
          command: cd android && sh gradlew assemble
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum  "android/libqaul/build.gradle" }}-{{ checksum  "android/blemodule/build.gradle" }}
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
            - android/blemodule/build/outputs/aar/blemodule-debug.aar
            - android/libqaul/build/outputs/aar/libqaul-debug.aar
  # #  ---------------------------------------------
  # #  Android
  # #  ---------------------------------------------
  android-beta-deploy:
    executor: android-flutter
    working_directory: ~/qaul-libp2p/qaul_ui/android
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_LANE: upload_beta_playstore
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      SUPPLY_JSON_KEY: ~/qaul-libp2p/qaul_ui/android/google-credentials.json
      <<: *flutter_version
    shell: /bin/bash --login -o pipefail
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - attach_workspace:
          at: ~/qaul-libp2p
      - run:
          name: Check for presence of AAR Files
          command: |
            if [ [ ! -f android/libqaul/build/outputs/aar/libqaul-debug.aar ] || [ ! -f android/blemodule/build/outputs/aar/blemodule-debug.aar ] ]; then
              echo "Libqaul/blemodule AAR file could not be found. That's probably due an error in persisting files to workspace"; exit 1
            fi
      - install-flutter-linux:
          version: "$FLUTTER_VERSION"
      - install-flutter-deps
      - run:
          name: Install Bundler
          command: ruby --version && sudo gem install bundler -N -v "$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1)"
      - install-bundler-deps
      - run: echo "$PLAY_STORE_UPLOAD_KEY" | base64 --decode > app/upload-keystore.jks
      - run: echo "$PLAY_STORE_UPLOAD_KEY_INFO" | base64 --decode > key.properties
      - run: echo "$PLAY_STORE_JSON_KEY" | base64 --decode > google-credentials.json
      - run:
          name: fastlane
          command: bundle exec fastlane $FASTLANE_LANE
      - store_artifacts:
          path: output
          destination: output
  # #  ---------------------------------------------
  # #  iOS
  # #  ---------------------------------------------
  ios-beta-deploy:
    macos:
      xcode: 13.0.0
    <<: *flutter_ios_dir
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_LANE: upload_testflight
      <<: *flutter_version
    shell: /bin/bash --login -o pipefail
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - install-flutter-macos:
          version: "$FLUTTER_VERSION"
      - install-flutter-deps
      - install-bundler-deps
      - install-cocoapods-deps
      - run:
          name: Build Flutter iOS Configuration
          command: flutter build ios --release --no-codesign --config-only
      - run:
          name: fastlane
          command: bundle exec fastlane $FASTLANE_LANE
      - store_artifacts:
          path: output
          destination: output

workflows:
  flutter-ci-cd-workflow:
    jobs:
      - flutter-analyze
      - flutter-test
      - build-libqaul-android:
          filters:
            branches:
              only: beta
      - hold:
          type: approval
          requires:
            - flutter-test
            - flutter-analyze
          filters:
            branches:
              only: beta
      - android-beta-deploy:
          requires:
            - hold
            - build-libqaul-android
          filters:
            branches:
              only: beta
#      - ios-beta-deploy:
#          requires:
#            - hold
#          filters:
#            branches:
#              only: beta

commands:
  checkout-project:
    description: "Invokes the checkout CircleCI step, declaring `path` as the root of the project (defined by `checkout_to_project_root` anchor)"
    <<: *checkout_to_root


  # ------------------------------------------------
  # Flutter-related commands
  # ------------------------------------------------
  install-flutter-deps:
    description: "Install Flutter dependencies"
    parameters:
      pub-cache:
        type: string
        default: "~/.pub-cache"
      dart-tool-cache:
        type: string
        default: ".dart_tool"
    steps:
      - run: flutter doctor --verbose
      - run:
          name: "Prepare For Cache Key"
          command: |
            cat "$(find .. -iname "pubspec.lock" | head -n 1)" > pubspec.rev
      - restore_cache:
          name: Restore Flutter pub cache
          key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
      - run:
          name: Install Flutter Dependencies
          command: flutter pub get
      - save_cache:
          name: Save Flutter pub cache
          key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
          paths:
            - << parameters.dart-tool-cache >>
            - << parameters.pub-cache >>

  install-bundler-deps:
    description: "Install Bundle dependencies"
    steps:
      - restore_cache:
          name: Restore Bundle cache
          keys:
            - gem-cache-v2-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - gem-cache-v2-{{ arch }}-
            - gem-cache-v2-
      - run:
          name: Install Bundle
          command: bundle check || sudo bundle install --path vendor/bundle
      - save_cache:
          name: Save Bundle cache
          key: gem-cache-v2-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle


  # #  ---------------------------------------------
  # #  (Flutter) Android-related commands
  # #  ---------------------------------------------
  install-flutter-linux:
    description: "Installs the Linux flutter binary"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: Install Flutter
          command: |
            cd && mkdir .flutter-sdk
            cd .flutter-sdk
            curl --fail --remote-time --silent --location -O https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_<< parameters.version >>-stable.tar.xz
            tar xf flutter_linux_<< parameters.version >>-stable.tar.xz --strip-components=1
            rm flutter_linux_<< parameters.version >>-stable.tar.xz
            echo "export PATH=$PATH:`pwd`/bin" >> $BASH_ENV


  # #  ---------------------------------------------
  # #  (Flutter) iOS-related commands
  # #  ---------------------------------------------
  install-flutter-macos:
    description: "Installs the MacOS flutter binary"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: Install Flutter
          command: |
            cd && mkdir .flutter-sdk
            cd .flutter-sdk
            curl --fail --remote-time --silent --location -O https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_<< parameters.version >>-stable.zip
            unzip flutter_macos_<< parameters.version >>-stable.zip
            rm flutter_macos_<< parameters.version >>-stable.zip
            echo "export PATH=$PATH:`pwd`/flutter/bin" >> $BASH_ENV

  install-cocoapods-deps:
    description: "Install Pods dependencies"
    steps:
      - restore_cache:
          name: Restore CocoaPods cache
          key: pods-cache-v1-{{ arch }}-{{ checksum "Podfile.lock" }}
      - run:
          name: Install CocoaPods
          command: bundle exec pod install
      - save_cache:
          name: Save CocoaPods cache
          key: pods-cache-v1-{{ arch }}-{{ checksum "Podfile.lock" }}
          paths:
            - ./Pods


  # ------------------------------------------------
  # Rust-related commands
  # ------------------------------------------------
  setup-sccache:
    description: "Installs and configures sccache as a wrapper for rustc"
    steps:
      - run:
          name: Install sccache
          command: |
            cargo install sccache
            # This configures Rust to use sccache.
            echo 'export "RUSTC_WRAPPER"="sccache"' >> $BASH_ENV
            # This is the maximum space sccache cache will use on disk.
            echo 'export "SCCACHE_CACHE_SIZE"="1G"' >> $BASH_ENV
            sccache --version
  restore-sccache-cache:
    steps:
      - restore_cache:
          name: Restore sccache cache
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}
  save-sccache-cache:
    steps:
      - save_cache:
          name: Save sccache cache
          # We use {{ epoch }} to always upload a fresh cache:
          # Of course, restore_cache will not find this exact key,
          # but it will fall back to the closest key (aka the most recent).
          # See https://discuss.circleci.com/t/add-mechanism-to-update-existing-cache-key/9014/13
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}-{{ epoch }}
          paths:
            - "~/.cache/sccache"