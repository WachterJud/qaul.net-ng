#! /bin/bash

# Pre-step: assert that the script is being run from rust/libqaul
PATTERN="^.*/installers/macos/bin\$"
if [[ ! $(pwd) =~ $PATTERN ]]; then
  echo "This script uses relative paths. Please run directly from it's directory."
  exit 1
fi

echo ""
echo "Building MacOS Flutter App..."

cd ../../../../qaul_ui || exit 1
flutter build macos --release

echo ""
echo "Signing *.App file with 'Developer ID Application' certificate..."
codesign --force --deep \
  -s "Developer ID Application: Verein zur Forderung von offenen Community-Projekten (VVYZ2Q8TUK)" \
  "build/macos/Build/Products/Release/qaul.net – قول.app"

echo ""
echo "Retrieving application version..."

VERSION=$(grep "version:" pubspec.yaml | awk '{ print $2}')
echo "Using App Version: $VERSION"

cd ../utilities/installers/macos || exit 1

echo ""
echo "Updating app version on config.json..."

sed -i sed "s/\"title\": \".*\"/\"title\": \"qaul-$VERSION\"/g" config.json

echo ""
echo "Updating the signing identity on config.json..."

npx appdmg ./config.json "qaul-$VERSION.dmg"
