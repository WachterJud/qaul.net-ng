executor: flutter-ios
steps:
  - checkout-project
  # Build libqaul
  - run:
      name: Install CMake
      command: brew install cmake
  - run:
      name: Install Rust
      command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  - setup-sccache
  - restore-sccache-cache
  - run:
      name: Build libqaul for ios Simulator
      command: |
        rustup target add x86_64-apple-ios
        cd ../../rust/libqaul
        cargo install cargo-lipo
        cargo lipo --release --targets x86_64-apple-ios
  - save-sccache-cache
  # test application
  - install-flutter:
      version: "$FLUTTER_VERSION"
  - install-flutter-deps
  - install-bundler-deps
  - install-cocoapods-deps
  - run:
      name: Install applesimutils
      command: |
        brew tap wix/brew
        brew install applesimutils
  - run:
      command: |
        # TODO remove
        ls -al
        ls ../../rust
        ls ../../rust/target
        ls ../../rust/target/universal
        ls ../../rust/target/universal/release

        cd ..  # qaul_ui root
        ID=$(xcrun simctl list devices | grep "iPhone 13 Pro Max" | head -1 | grep -E -o -i "([0-9a-f]{8}-([0-9a-f]{4}-){3}[0-9a-f]{12})")
        xcrun simctl boot "$ID"
        flutter devices
        applesimutils --byId "$ID" --bundle net.qaul.app --setPermissions notifications=YES
        flutter test integration_test -d "$ID" --dart-define=testing_mode=true
